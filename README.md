# icrypto
apple iOS system crypto framework(grpc or resultFul api)
see docs/crypto.swagger.json

base api address: https://im.app/api/v1/icrypto/

telegram: @dxxlabc

drm only work for A7(SEP)

# DeviceCertificate（UniqueDeviceCertificate）与 FairPlayKeyData 概览

1. **来源**  
   这两类数据均在**设备激活**过程中由苹果服务器下发（激活流程见下文）。其中 *DeviceCertificate* 用于设备身份/会话建立的证书链，*FairPlayKeyData* 则服务于 FairPlay DRM 环节的后续处理。

2. **DeviceCertificate（证书格式）**  
   属于标准 **X.509** 证书，可用常见工具解析。证书的管理与分发与苹果生态的通用证书体系一致。

3. **FairPlayKeyData（用途与形态）**  
   这是苹果自定义的、**加密/封装的二进制容器**，通常作为 **会话密钥材料/验证数据** 在 FairPlay 处理链中使用；不能简单称作“加密数据”或“解密密钥”。研究与抓包资料显示，它与本地 FairPlay 目录中的若干 **IC-Info** 文件存在严格对应关系。

4. **与设备的绑定关系（谨慎表述）**  
   这些数据由苹果签发与返回，**与设备存在一定绑定/校验关系**；但外部研究很难完整证明其所有**强绑定**细节，尤其是若绑定逻辑位于 **Secure Enclave（SEP）** 内部（SEP 中的 UID/GID 硬件根密钥不可导出）。因此，对“是否与所有硬件标识一一强绑定”的断言，宜保留为**有限可见性**。

---

# 激活流程与关键材料

1. **触发条件**  
   iOS、iPadOS、macOS 等设备在首次使用、刷机或反激活后，会与苹果激活服务通信，拉取关键证书与配置（含 *FairPlayKeyData*、激活记录等）。工具与文档将这份结果称为 **activation record**（`activation_record.plist`），并通过相应 API/协议应用到设备完成激活。

2. **iOS 10 之前**  
   旧版本中，激活流程相对简单。设备会收集 **SN/IMEI/ECID/UUID/基带序列号** 等**设备信息**，并在**同一请求**中**附带一个 X.509 CSR** 一并发往苹果服务器；服务器返回证书与激活数据。该结构在早期“ActivationInfo/Activation Token”资料与社区抓包中有较清晰体现。

3. **SEP 引入后的演进**  
   自 ARM64 与 **Secure Enclave（SEP）** 广泛应用后，激活/授权路径显著复杂化：  
   - 核心敏感材料与签名操作在 **sepOS/硬件 AES 引擎** 中完成；  
   - **硬件根密钥（UID/GID）** 仅在硬件内派生/使用，不可被软件（包括 sepOS）读出；  
   - 上层仅能请求“用这些硬件密钥做加/解密”，无法直接接触密钥本体。

4. **GID/UID 在证书与密钥派生中的角色**  
   - 苹果官方安全白皮书明确：很多密钥由 **UID 或 GID** 派生，密钥仅在硬件引擎内部存在；  
   - 学术/会议研究与外部分析亦表明：围绕 **IMG4/密钥包/证书链** 的处理，涉及 **GID 包装（wrap）** 与 **UID 绑定** 等硬件层保证。

5. **ECID（Exclusive/Unique Chip ID）**  
   ECID 是 **SoC 级唯一标识**，贯穿 SHSH/APTicket 与激活授权过程，是将签名/授权限定到**单台设备**的核心因素之一；该标识与硬件熔丝/SoC 绑定，**不可“改码”篡改**。

6. **请求签名与篡改阻断**  
   激活阶段由 SEP 生成/参与的请求体（含敏感字段）会被硬件内密钥**签名/校验**；由于密钥不可导出，**中途抓包改字段（如 ECID）会破坏签名**而被服务器或本地验证拒绝。

> **小结**：现代机型上，**伪造硬件标识去“改机激活”在架构上不可行**；早期例外通常依赖旧版基带/BootROM/链路的特定漏洞，而非通用手段。

---

# 市场“改机”的常见误解与现实

> 以下为对公开研究与社区现象的**中性技术描述**，非鼓励或指导；绕过安全机制/DRM 可能触法并违反服务条款。

1. **“半改机/BUG 改机”的本质**  
   多为**上层流程劫持**而非真正的硬件标识更改：例如在 **iMessage 注册/登录**链路中，通过 HOOK 或环境伪造，让“上送的设备信息”看起来与目标一致，从而影响**初始化验证**步骤。

2. **为何不能“彻底改机”**  
   一旦触及**重新激活/完整 DRM 握手**，就会遇到 **ECID/UID/GID** 级别的硬件绑定与签名校验——这部分在 SEP/硬件中完成，**无法通过抓包或用户态 patch 伪造**。

3. **关于“UIKCertification”的术语澄清**  
   公开资料与苹果官方文档中，常见的是 **UID/GID**、**Activation Record**、**SHSH/APTicket**、**FairPlay 验证数据**、**IDS（iMessage）Validation Data** 等术语；“UIKCertification”并非常见官方术语，更像是社区口语或内部命名。建议在文档中统一替换为更可考的术语，如 **“（iMessage/IDS）validation data”** 或 **“（激活）证书链/激活记录的一部分”**。

4. **关于“服务器记录 UID 证书”**  
   外部材料很少有**权威、可核查**的细节说明“首次激活即长期存档某个‘UID 证书’用于后续强匹配”。考虑到苹果明确强调硬件密钥**不可导出**且多以**派生/包装**形态参与，会话与注册过程确有**状态性与风险评分/权重**机制，但“长期以证书指纹强匹配 UID”的说法缺乏公开可信来源，建议降格为**可能性/社区推测**。

---

# iMessage（IDS）注册与“权重”

1. **协议复杂度与开放资料**  
   iMessage 使用 **IDS（Apple ID 服务）** 进行发现/注册/路由，注册阶段需要提交 **validation data（二进制验证数据）**，这是防止非苹果设备接入的关键门槛之一；社区对该部分有一定程度的逆向与讨论。

2. **“权重/信誉”因素**  
   业界与社区普遍认为，iMessage/IDS 会结合账号、设备历史、风控信号等做**信誉评估**（“权重”），具体细节并未公开；这也解释了为何同样的技术路径，在不同设备/账号上结果不同。公开新闻也多次报道第三方尝试“无 Mac 中继”直连 iMessage 的研究与其受限。

> **不建议**将主要精力投入到 iMessage 协议的逆向与运营：协议在演进，安全投入持续增加，收益/维护成本比低。

---

# 术语与事实速查

- **ECID**：SoC 级唯一标识，参与 SHSH/APTicket 与授权限定；不可修改。  
- **UID/GID**：硬件根密钥，仅在硬件 AES 引擎内派生/使用，不可导出。  
- **Activation Record**：激活协议返回的关键数据字典（含证书、票据、FairPlayKeyData 等），由工具/协议写入设备以完成激活。  
- **FairPlayKeyData**：FairPlay 相关的会话/验证数据容器，和本地 IC-Info 文件严格对应。  
- **（iMessage/IDS）Validation Data**：iMessage 注册时必须提交的二进制验证数据，用以校验设备与环境。

---

## 合规与道德提示
本文档仅用于**安全研究与科普**。试图绕过激活、DRM、或服务风控可能违反法律与服务条款，且存在账号/设备封禁与法律风险。请勿将本文档用于任何非授权用途。
