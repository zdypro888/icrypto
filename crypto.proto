syntax = "proto3";
package icrypto;

import "google/api/annotations.proto";

option go_package = "github.com/zdypro888/icrypto";

// 操作系统类型枚举
enum OSEnum {
  UNSPECIFIED = 0;
  MACOS       = 1;
  IOS         = 2;
  ANDROID     = 3;
}

// 设备信息
message Device {
  OSEnum os_type       = 1;
  string serial_number = 2;
  // macOS
  string model         = 3;
  uint64 os_revision   = 4;
  string os_version    = 5;
  string board_id      = 6;
  string disk_id       = 7;
  string hardwareUUID  = 8;
  string bootUUID      = 9;
  bytes  MACAddress    = 10;
  bytes  ROM           = 11;
  string MLB           = 12;
  bytes  kGq3489ugfi   = 13;
  bytes  kFyp98tpgj    = 14;
  bytes  kkbjfrfpoJU   = 15;
  bytes  koycqAZloTNDm = 16;
  bytes  kabKPld1EcMni = 17;
  // iOS
  string product_type      = 18;
  string IMEI              = 19;
  uint64 unique_chip_id    = 20;
  string unique_device_id  = 21;
  string wifi_address      = 22;
  string bluetooth_address = 23;
  string secure_elementSN  = 24;
  // Global
  string build_version     = 25;
  string product_version   = 26;
  bytes  fairplay_key_data = 27;
  bytes  ADI               = 28;
  bytes  AP_ticket         = 29;
  bytes  SUInfo            = 30;
}

// 初始化类型枚举
enum InitializeType {
  AUTO           = 0;
  WITH_ABSINTHE  = 1;
  WITH_DRM       = 2;
  MACOSDISABLE15 = 4;
}

// 初始化请求
message InitializeRequest {
  InitializeType  type     = 1;
  Device          device   = 2;
  repeated string controls = 3;
}

// 初始化响应
message InitializeResponse {
  Device device = 1;
}

// 结束请求
message FinalizeRequest {
  repeated string controls = 1;
}

// 结束响应
message FinalizeResponse {}

// DRM 激活握手请求
message ActivationDRMHandshakeRequest {
  repeated string controls = 1;
}

// DRM 激活握手响应
message ActivationDRMHandshakeResponse {
  bytes collection_blob           = 1;
  bytes handshake_request_message = 2;
}

// DRM 激活处理请求
message ActivationDRMProcessRequest {
  bytes           SUInfo                     = 1;
  bytes           handshake_response_message = 2;
  bytes           serverKP                   = 3;
  repeated string controls                   = 4;
}

// DRM 激活处理响应
message ActivationDRMProcessResponse {
  bytes UIK = 1;
  bytes RK  = 2;
}

// DRM 激活签名请求
message ActivationDRMSignatureRequest {
  bytes           activation_info_xml = 1;
  repeated string controls            = 2;
}

// DRM 激活签名响应
message ActivationDRMSignatureResponse {
  bytes fairplay_cert_chain = 1;
  bytes fairplay_signature  = 2;
  bytes RKSignature         = 3;
  bytes sign_act_request    = 4;
  bytes serverKP            = 5;
}

// 旧版激活请求
message ActivationDeprecatedRequest {
  bytes           activation_info_xml = 1;
  repeated string controls            = 2;
}

// 旧版激活响应
message ActivationDeprecatedResponse {
  bytes sign = 1;
  bytes cert = 2;
}

// 激活记录请求
message ActivationRecordRequest {
  bool            unbrick                   = 1;
  bytes           account_token_certificate = 2;
  bytes           device_certificate        = 3;
  bytes           regulatory_info           = 4;
  bytes           fairplay_key_data         = 5;
  bytes           account_token             = 6;
  bytes           account_token_signature   = 7;
  bytes           unique_device_certificate = 8;
  repeated string controls                  = 9;
}

// 激活记录响应
message ActivationRecordResponse {
  bytes subCAKey        = 1;
  bytes attestation_key = 2;
  bytes UIK             = 3;
  bytes RK              = 4;
  bytes psc_sui         = 5;
}

// ADI 开始配置请求
message ADIStartProvisioningRequest {
  int64           DSID     = 1;
  bytes           SPIM     = 2;
  repeated string controls = 3;
}

// ADI 开始配置响应
message ADIStartProvisioningResponse {
  uint64 session = 1;
  bytes  CPIM    = 2;
}

// ADI 结束配置请求
message ADIEndProvisioningRequest {
  uint64          session  = 1;
  int64           DSID     = 2;
  int64           RINFO    = 3;
  bytes           PTM      = 4;
  bytes           TK       = 5;
  bytes           ADI      = 6;
  repeated string controls = 7;
}

// ADI 结束配置响应
message ADIEndProvisioningResponse {
  bytes MID = 1;
  bytes OTP = 2;
  bytes ADI = 3;
}

// ADI 生成登录码请求
message ADIGenerateLoginCodeRequest {
  int64           DSID     = 1;
  bytes           ADI      = 2;
  repeated string controls = 3;
}

// ADI 生成登录码响应
message ADIGenerateLoginCodeResponse {
  int32  code       = 1;
  uint32 login_code = 2;
}

// Absinthe Hello 请求
message AbsintheHelloRequest {
  int32           mode     = 1;
  repeated string controls = 2;
}

// Absinthe Hello 响应
message AbsintheHelloResponse {
  bytes hello_message = 1;
}

// Absinthe 添加选项请求
message AbsintheAddOptionRequest {
  bytes           bik_key                = 1;
  bytes           baa_cert               = 2;
  bytes           intermediate_root_cert = 3;
  repeated string controls               = 4;
}

// Absinthe 添加选项响应
message AbsintheAddOptionResponse {}

// Absinthe 激活会话请求
message AbsintheActivateSessionRequest {
  bytes           validation_data = 1;
  bytes           server_key      = 2;
  repeated string controls        = 3;
}

// Absinthe 激活会话响应
message AbsintheActivateSessionResponse {}

// Absinthe 签名数据请求
message AbsintheSignDataRequest {
  bytes           sign_data = 1;
  repeated string controls  = 2;
}

// Absinthe 签名数据响应
message AbsintheSignDataResponse {
  bytes signature    = 1;
  bytes out_serv_key = 2;
}

// Identity 会话请求
message IdentitySessionRequest {
  bytes           cert     = 1;
  repeated string controls = 2;
}

// Identity 会话响应
message IdentitySessionResponse {
  bytes request = 1;
}

// Identity 验证请求
message IdentityValidationRequest {
  bytes           response  = 1;
  bytes           sign_data = 2;
  repeated string controls  = 3;
}

// Identity 验证响应
message IdentityValidationResponse {
  bytes validation_data = 1;
}

// SAP 交换请求
message SAPExchangeRequest {
  int32           version  = 1;
  bytes           data     = 2;
  repeated string controls = 3;
}

// SAP 交换响应
message SAPExchangeResponse {
  bytes exchange_data = 1;
}

// SAP 质数签名请求
message SAPSignPrimeRequest {
  bytes           sign_data = 1;
  repeated string controls  = 2;
}

// SAP 质数签名响应
message SAPSignPrimeResponse {
  bytes signature = 1;
}

// SAP 质数验证请求
message SAPVerifyPrimeRequest {
  bytes           data     = 1;
  repeated string controls = 2;
}

// SAP 质数验证响应
message SAPVerifyPrimeResponse {}

// SAP 签名请求
message SAPSignRequest {
  bytes           sign_data = 1;
  repeated string controls  = 2;
}

// SAP 签名响应
message SAPSignResponse {
  bytes signature = 1;
}

// SAP 验证请求
message SAPVerifyRequest {
  bytes           data      = 1;
  bytes           signature = 2;
  repeated string controls  = 3;
}

// SAP 验证响应
message SAPVerifyResponse {}

// 加密服务
service CryptService {
  // 初始化
  rpc Initialize(InitializeRequest) returns (InitializeResponse) {
    option (google.api.http) = {
      post: "/initialize"
      body: "*"
    };
  }

  // 结束
  rpc Finalize(FinalizeRequest) returns (FinalizeResponse) {
    option (google.api.http) = {
      post: "/finalize"
      body: "*"
    };
  }

  // DRM 激活握手
  rpc ActivationDRMHandshake(ActivationDRMHandshakeRequest) returns (ActivationDRMHandshakeResponse) {
    option (google.api.http) = {
      post: "/activation/drm/handshake"
      body: "*"
    };
  }

  // DRM 激活处理
  rpc ActivationDRMProcess(ActivationDRMProcessRequest) returns (ActivationDRMProcessResponse) {
    option (google.api.http) = {
      post: "/activation/drm/process"
      body: "*"
    };
  }

  // DRM 激活签名
  rpc ActivationDRMSignature(ActivationDRMSignatureRequest) returns (ActivationDRMSignatureResponse) {
    option (google.api.http) = {
      post: "/activation/drm/signature"
      body: "*"
    };
  }

  // 旧版激活
  rpc ActivationDeprecated(ActivationDeprecatedRequest) returns (ActivationDeprecatedResponse) {
    option (google.api.http) = {
      post: "/activation/deprecated"
      body: "*"
    };
  }

  // 激活记录
  rpc ActivationRecord(ActivationRecordRequest) returns (ActivationRecordResponse) {
    option (google.api.http) = {
      post: "/activation/record"
      body: "*"
    };
  }

  // ADI 开始配置
  rpc ADIStartProvisioning(ADIStartProvisioningRequest) returns (ADIStartProvisioningResponse) {
    option (google.api.http) = {
      post: "/adi/start-provisioning"
      body: "*"
    };
  }

  // ADI 结束配置
  rpc ADIEndProvisioning(ADIEndProvisioningRequest) returns (ADIEndProvisioningResponse) {
    option (google.api.http) = {
      post: "/adi/end-provisioning"
      body: "*"
    };
  }

  // ADI 生成登录码
  rpc ADIGenerateLoginCode(ADIGenerateLoginCodeRequest) returns (ADIGenerateLoginCodeResponse) {
    option (google.api.http) = {
      post: "/adi/generate-login-code"
      body: "*"
    };
  }

  // Absinthe Hello
  rpc AbsintheHello(AbsintheHelloRequest) returns (AbsintheHelloResponse) {
    option (google.api.http) = {
      post: "/absinthe/hello"
      body: "*"
    };
  }

  // Absinthe 添加选项
  rpc AbsintheAddOption(AbsintheAddOptionRequest) returns (AbsintheAddOptionResponse) {
    option (google.api.http) = {
      post: "/absinthe/add-option"
      body: "*"
    };
  }

  // Absinthe 激活会话
  rpc AbsintheActivateSession(AbsintheActivateSessionRequest) returns (AbsintheActivateSessionResponse) {
    option (google.api.http) = {
      post: "/absinthe/activate-session"
      body: "*"
    };
  }

  // Absinthe 签名数据
  rpc AbsintheSignData(AbsintheSignDataRequest) returns (AbsintheSignDataResponse) {
    option (google.api.http) = {
      post: "/absinthe/sign-data"
      body: "*"
    };
  }

  // Identity 会话
  rpc IdentitySession(IdentitySessionRequest) returns (IdentitySessionResponse) {
    option (google.api.http) = {
      post: "/identity/session"
      body: "*"
    };
  }

  // Identity 验证
  rpc IdentityValidation(IdentityValidationRequest) returns (IdentityValidationResponse) {
    option (google.api.http) = {
      post: "/identity/validation"
      body: "*"
    };
  }

  // SAP 交换
  rpc SAPExchange(SAPExchangeRequest) returns (SAPExchangeResponse) {
    option (google.api.http) = {
      post: "/sap/exchange"
      body: "*"
    };
  }

  // SAP 质数签名
  rpc SAPSignPrime(SAPSignPrimeRequest) returns (SAPSignPrimeResponse) {
    option (google.api.http) = {
      post: "/sap/sign-prime"
      body: "*"
    };
  }

  // SAP 质数验证
  rpc SAPVerifyPrime(SAPVerifyPrimeRequest) returns (SAPVerifyPrimeResponse) {
    option (google.api.http) = {
      post: "/sap/verify-prime"
      body: "*"
    };
  }

  // SAP 签名
  rpc SAPSign(SAPSignRequest) returns (SAPSignResponse) {
    option (google.api.http) = {
      post: "/sap/sign"
      body: "*"
    };
  }

  // SAP 验证
  rpc SAPVerify(SAPVerifyRequest) returns (SAPVerifyResponse) {
    option (google.api.http) = {
      post: "/sap/verify"
      body: "*"
    };
  }
}
